const h=!!navigator.userAgent.match(/Macintosh/);class E{constructor(t,i){this.input=t,this.list=i,this.isComposing=!1,i.id||(i.id=`combobox-${Math.random().toString().slice(2,6)}`),this.keyboardEventHandler=n=>x(n,this),this.compositionEventHandler=n=>k(n,this),this.inputHandler=this.clearSelection.bind(this),t.setAttribute("role","combobox"),t.setAttribute("aria-controls",i.id),t.setAttribute("aria-expanded","false"),t.setAttribute("aria-autocomplete","list"),t.setAttribute("aria-haspopup","listbox")}destroy(){this.clearSelection(),this.stop(),this.input.removeAttribute("role"),this.input.removeAttribute("aria-controls"),this.input.removeAttribute("aria-expanded"),this.input.removeAttribute("aria-autocomplete"),this.input.removeAttribute("aria-haspopup")}start(){this.input.setAttribute("aria-expanded","true"),this.input.addEventListener("compositionstart",this.compositionEventHandler),this.input.addEventListener("compositionend",this.compositionEventHandler),this.input.addEventListener("input",this.inputHandler),this.input.addEventListener("keydown",this.keyboardEventHandler),this.list.addEventListener("click",m)}stop(){this.clearSelection(),this.input.setAttribute("aria-expanded","false"),this.input.removeEventListener("compositionstart",this.compositionEventHandler),this.input.removeEventListener("compositionend",this.compositionEventHandler),this.input.removeEventListener("input",this.inputHandler),this.input.removeEventListener("keydown",this.keyboardEventHandler),this.list.removeEventListener("click",m)}navigate(t=1){const i=Array.from(this.list.querySelectorAll('[aria-selected="true"]')).filter(f)[0],n=Array.from(this.list.querySelectorAll('[role="option"]')).filter(f),o=n.indexOf(i);if(o===n.length-1&&t===1||o===0&&t===-1){this.clearSelection(),this.input.focus();return}let r=t===1?0:n.length-1;if(i&&o>=0){const a=o+t;a>=0&&a<n.length&&(r=a)}const s=n[r];if(!!s)for(const a of n)s===a?(this.input.setAttribute("aria-activedescendant",s.id),s.setAttribute("aria-selected","true"),L(this.list,s)):a.setAttribute("aria-selected","false")}clearSelection(){this.input.removeAttribute("aria-activedescendant");for(const t of this.list.querySelectorAll('[aria-selected="true"]'))t.setAttribute("aria-selected","false")}}function x(e,t){if(!(e.shiftKey||e.metaKey||e.altKey)&&!(!h&&e.ctrlKey)&&!t.isComposing)switch(e.key){case"Enter":case"Tab":y(t.input,t.list)&&e.preventDefault();break;case"Escape":t.clearSelection();break;case"ArrowDown":t.navigate(1),e.preventDefault();break;case"ArrowUp":t.navigate(-1),e.preventDefault();break;case"n":h&&e.ctrlKey&&(t.navigate(1),e.preventDefault());break;case"p":h&&e.ctrlKey&&(t.navigate(-1),e.preventDefault());break;default:if(e.ctrlKey)break;t.clearSelection()}}function m(e){if(!(e.target instanceof Element))return;const t=e.target.closest('[role="option"]');!t||t.getAttribute("aria-disabled")!=="true"&&w(t)}function y(e,t){const i=t.querySelector('[aria-selected="true"]');return i?(i.getAttribute("aria-disabled")==="true"||i.click(),!0):!1}function w(e){e.dispatchEvent(new CustomEvent("combobox-commit",{bubbles:!0}))}function f(e){return!e.hidden&&!(e instanceof HTMLInputElement&&e.type==="hidden")&&(e.offsetWidth>0||e.offsetHeight>0)}function k(e,t){t.isComposing=e.type==="compositionstart",!!document.getElementById(t.input.getAttribute("aria-controls")||"")&&t.clearSelection()}function L(e,t){A(e,t)||(e.scrollTop=t.offsetTop)}function A(e,t){const i=e.scrollTop,n=i+e.clientHeight,o=t.offsetTop,r=o+t.clientHeight;return o>=i&&r<=n}const I=/\s|\(|\[/;function T(e,t,i,{multiWord:n,lookBackIndex:o,lastMatchPosition:r}={multiWord:!1,lookBackIndex:0,lastMatchPosition:null}){let s=e.lastIndexOf(t,i-1);if(s===-1||s<o)return;if(n){if(r!=null){if(r===s)return;s=r-t.length}if(e[s+1]===" "&&i>=s+t.length+1||e.lastIndexOf(`
`,i-1)>s||e.lastIndexOf(".",i-1)>s)return}else if(e.lastIndexOf(" ",i-1)>s)return;const a=e[s-1];return a&&!I.test(a)?void 0:{text:e.substring(s+t.length,i),position:s+t.length}}const M=["position:absolute;","overflow:auto;","word-wrap:break-word;","top:0px;","left:-9999px;"],v=["box-sizing","font-family","font-size","font-style","font-variant","font-weight","height","letter-spacing","line-height","max-height","min-height","padding-bottom","padding-left","padding-right","padding-top","border-bottom","border-left","border-right","border-top","text-decoration","text-indent","text-transform","width","word-spacing"],b=new WeakMap;function C(e,t){const i=e.nodeName.toLowerCase();if(i!=="textarea"&&i!=="input")throw new Error("expected textField to a textarea or input");let n=b.get(e);if(n&&n.parentElement===e.parentElement)n.innerHTML="";else{n=document.createElement("div"),b.set(e,n);const a=window.getComputedStyle(e),c=M.slice(0);i==="textarea"?c.push("white-space:pre-wrap;"):c.push("white-space:nowrap;");for(let l=0,p=v.length;l<p;l++){const d=v[l];c.push(`${d}:${a.getPropertyValue(d)};`)}n.style.cssText=c.join(" ")}const o=document.createElement("span");o.style.cssText="position: absolute;",o.innerHTML="&nbsp;";let r,s;if(typeof t=="number"){let a=e.value.substring(0,t);a&&(r=document.createTextNode(a)),a=e.value.substring(t),a&&(s=document.createTextNode(a))}else{const a=e.value;a&&(r=document.createTextNode(a))}if(r&&n.appendChild(r),n.appendChild(o),s&&n.appendChild(s),!n.parentElement){if(!e.parentElement)throw new Error("textField must have a parentElement to mirror");e.parentElement.insertBefore(n,e)}return n.scrollTop=e.scrollTop,n.scrollLeft=e.scrollLeft,{mirror:n,marker:o}}function H(e,t=e.selectionEnd){const{mirror:i,marker:n}=C(e,t),o=i.getBoundingClientRect(),r=n.getBoundingClientRect();return setTimeout(()=>{i.remove()},5e3),{top:r.top-o.top,left:r.left-o.left}}const u=new WeakMap;class S{constructor(t,i){this.expander=t,this.input=i,this.combobox=null,this.menu=null,this.match=null,this.justPasted=!1,this.lookBackIndex=0,this.oninput=this.onInput.bind(this),this.onpaste=this.onPaste.bind(this),this.onkeydown=this.onKeydown.bind(this),this.oncommit=this.onCommit.bind(this),this.onmousedown=this.onMousedown.bind(this),this.onblur=this.onBlur.bind(this),this.interactingWithList=!1,i.addEventListener("paste",this.onpaste),i.addEventListener("input",this.oninput),i.addEventListener("keydown",this.onkeydown),i.addEventListener("blur",this.onblur)}destroy(){this.input.removeEventListener("paste",this.onpaste),this.input.removeEventListener("input",this.oninput),this.input.removeEventListener("keydown",this.onkeydown),this.input.removeEventListener("blur",this.onblur)}dismissMenu(){this.deactivate()&&(this.lookBackIndex=this.input.selectionEnd||this.lookBackIndex)}activate(t,i){var n,o;if(this.input!==document.activeElement&&this.input!==((o=(n=document.activeElement)===null||n===void 0?void 0:n.shadowRoot)===null||o===void 0?void 0:o.activeElement))return;this.deactivate(),this.menu=i,i.id||(i.id=`text-expander-${Math.floor(Math.random()*1e5).toString()}`),this.expander.append(i),this.combobox=new E(this.input,i);const{top:r,left:s}=H(this.input,t.position);i.style.top=`${r}px`,i.style.left=`${s}px`,this.combobox.start(),i.addEventListener("combobox-commit",this.oncommit),i.addEventListener("mousedown",this.onmousedown),this.combobox.navigate(1)}deactivate(){const t=this.menu;return!t||!this.combobox?!1:(this.menu=null,t.removeEventListener("combobox-commit",this.oncommit),t.removeEventListener("mousedown",this.onmousedown),this.combobox.destroy(),this.combobox=null,t.remove(),!0)}onCommit({target:t}){const i=t;if(!(i instanceof HTMLElement)||!this.combobox)return;const n=this.match;if(!n)return;const o=this.input.value.substring(0,n.position-n.key.length),r=this.input.value.substring(n.position+n.text.length),s={item:i,key:n.key,value:null};if(!this.expander.dispatchEvent(new CustomEvent("text-expander-value",{cancelable:!0,detail:s}))||!s.value)return;const c=`${s.value} `;this.input.value=o+c+r;const l=o.length+c.length;this.deactivate(),this.input.focus({preventScroll:!0}),this.input.selectionStart=l,this.input.selectionEnd=l,this.lookBackIndex=l,this.match=null}onBlur(){if(this.interactingWithList){this.interactingWithList=!1;return}this.deactivate()}onPaste(){this.justPasted=!0}async onInput(){if(this.justPasted){this.justPasted=!1;return}const t=this.findMatch();if(t){this.match=t;const i=await this.notifyProviders(t);if(!this.match)return;i?this.activate(t,i):this.deactivate()}else this.match=null,this.deactivate()}findMatch(){const t=this.input.selectionEnd||0,i=this.input.value;t<=this.lookBackIndex&&(this.lookBackIndex=t-1);for(const{key:n,multiWord:o}of this.expander.keys){const r=T(i,n,t,{multiWord:o,lookBackIndex:this.lookBackIndex,lastMatchPosition:this.match?this.match.position:null});if(r)return{text:r.text,key:n,position:r.position}}}async notifyProviders(t){const i=[],n=a=>i.push(a);return this.expander.dispatchEvent(new CustomEvent("text-expander-change",{cancelable:!0,detail:{provide:n,text:t.text,key:t.key}}))?(await Promise.all(i)).filter(a=>a.matched).map(a=>a.fragment)[0]:void 0}onMousedown(){this.interactingWithList=!0}onKeydown(t){t.key==="Escape"&&(this.match=null,this.deactivate()&&(this.lookBackIndex=this.input.selectionEnd||this.lookBackIndex,t.stopImmediatePropagation(),t.preventDefault()))}}class g extends HTMLElement{get keys(){const t=this.getAttribute("keys"),i=t?t.split(" "):[],n=this.getAttribute("multiword"),o=n?n.split(" "):[],r=o.length===0&&this.hasAttribute("multiword");return i.map(s=>({key:s,multiWord:r||o.includes(s)}))}connectedCallback(){const t=this.querySelector('input[type="text"], textarea');if(!(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement))return;const i=new S(this,t);u.set(this,i)}disconnectedCallback(){const t=u.get(this);!t||(t.destroy(),u.delete(this))}dismiss(){const t=u.get(this);!t||t.dismissMenu()}}window.customElements.get("text-expander")||(window.TextExpanderElement=g,window.customElements.define("text-expander",g));
